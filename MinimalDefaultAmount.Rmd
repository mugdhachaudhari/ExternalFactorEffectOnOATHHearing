---
title: "MinimalDefaultAmount"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r Set Working Directory}
setwd("F:/MSCSNyuPoly/Fall2016/FoundationsOfDataScience/Project/Work")
```

install.packages("sqldf")
install.packages("ggplot2")
data2015 <- read.csv("2015_dataMain.csv")
#COnvert factor to character
data2015$Total.Violation.Amount <- as.character(levels(data2015$Total.Violation.Amount)[data2015$Total.Violation.Amount])
#Replace $ sign with blank
data2015$Total.Violation.Amount <- sapply(data2015["Total.Violation.Amount"], function(x) as.character(gsub("\\$", "", x)))
#Convert character to numeric
data2015$Total.Violation.Amount <- as.numeric(data2015$Total.Violation.Amount)
colnames(data2015)
data2015 <- subset(data2015, Charge..1..Code.Section != "")
data2015[data2015$Total.Violation.Amount == 0,]
#Select only Total Violation Amount column
data2015Amt <- subset(data2015, select = c("Total.Violation.Amount"))
data2015Amt[data2015Amt$Total.Violation.Amount == 0,]
#Total number of violations
ttlViolation <- nrow(data2015Amt)
#Aggregation to find percentage occurenece of each penalty amount
options(scipen = 999)  #To disable scietific notation
ttlAgg <- do.call(data.frame, aggregate(cbind(count = Total.Violation.Amount) ~ Total.Violation.Amount, data = data2015Amt, 
          FUN = function(x) c({round((NROW(x) / ttlViolation) * 100, digits = 4)}, {NROW(x)})))
colnames(ttlAgg) <- c("Total.Violation.Amount", "ttlPercent", "ttlCnt")

#Select data where Hearing Status is PAID IN FULL and Decision Date is blank. It means that amount has been paid in full before taking any decision
data2015Paid <- subset(data2015, Hearing.Status == "PAID IN FULL" & Decision.Date == "", select = c("Total.Violation.Amount"))
#Aggregation  to find percentage occurence of penalty where user has paid fully
paidAgg <- do.call(data.frame, aggregate(cbind(count = Total.Violation.Amount) ~ Total.Violation.Amount, data = data2015Paid, FUN = function(x)c({round((NROW(x) / ttlViolation) * 100, digits = 4)}, {NROW(x)})))
colnames(paidAgg) <- c("Total.Violation.Amount", "paidPercentFromTotal", "paidCount")

#Left join of ttl Percentage and paid percentage
mergeData <- merge(x = ttlAgg, y = paidAgg, by = "Total.Violation.Amount", all.x = TRUE)
colnames(mergeData)
head(mergeData)
#Replace NA with 0
mergeData <- data.frame(apply(mergeData, 2, function(x){replace(x, is.na(x), 0)}))
#Calculate percentage violations per amount where penalty was paid before decision
mergeData$paidPercentPerPenalty <- (mergeData[,"paidCount"] / mergeData[,"ttlCnt"]) * 100

mergeData
colnames(mergeData)
#Plot penalty amount vs percentage of violations in which penalty was paid before decision

sampleMergeData <- mergeData[mergeData$Total.Violation.Amount < 4000,]


plot(mergeData[,"Total.Violation.Amount"], mergeData[,"paidPercentPerPenalty"], type = 'o', main = "No of times Penalty Paid before Decision per Amount", xlab = "Penalty Amount", ylab = "Percentage", col = "blue")


plot(mergeData[,"Total.Violation.Amount"], mergeData[,"ttlPercent"], type = 'o', main = "", xlab = "Penalty Amount", ylab = "Percentage", col = "blue")
lines(mergeData[,"Total.Violation.Amount"], mergeData[,"paidPercentFromTotal"], col = "red")

max(mergeData[,c(3)])
head(mergeData)
rownames(mergeData) <- mergeData$Total.Violation.Amount
barplot(t(as.matrix(mergeData[,c(3, 5)])), col=c("darkblue","red"), legend=c("Total", "Paid"),ylim=c(0, 320000), xlab = "Amount", main = "Amount vs Count of Total & Amount Paid before Decision", beside=TRUE)

We are not able to see proper result because of large data. Even with barplot we are not able to visualize properly. We can divide data into bins to get overall estimation.


library(Hmisc)
mergeData$amountGrp <- cut2(mergeData$Total.Violation.Amount, c(101, 1001, 2501, 5001, 10001, 100000 ))
mergeDataAgg <- aggregate(mergeData[,c("ttlCnt","paidCount")], by=list(mergeData$amountGrp), "sum")
colnames(mergeDataAgg) <- c("Violation.Amount.Grp",  "ttlCnt", "paidCount")

barPlotData <- t(as.matrix(mergeDataAgg[,c(2,3)]))
names(barPlotData) <- mergeDataAgg[,c(1)]
bar <- barplot(barPlotData, col=c("darkblue","red"), legend=c("Total", "Paid"),ylim=c(0, 420642),ylab = "Count", xlab = "", main = "Amount vs Count of Total & Amount Paid before Decision", beside=TRUE)
axis(1, at=bar[1,], labels=mergeDataAgg[,c(1)], font = 2, cex.axis=0.7, las=3)

We can see from plot that maximum number of times amount was paid before decision when penalty amount was less than or equal to 100.

So lets zoom out there.

barplot(t(as.matrix(mergeData[mergeData$Total.Violation.Amount <= 100,c(3, 5)])), col=c("darkblue","red"),ylim=c(0, 320000), xlab = "Amount", main = "Amount vs Count of Total & Amount Paid before Decision", beside=TRUE)


plot(as.numeric(mergeDataAgg[,"Violation.Amount.Grp"]), mergeDataAgg[,"ttlCnt"], type = 'o', main = "", xlab = "Penalty Amount", ylab = "Percentage", col = "blue")
lines(as.numeric(mergeDataAgg[,"Violation.Amount.Grp"]), mergeDataAgg[,"paidCount"], col = "red")

#Same plot with less data
plot(sampleMergeData[,"Total.Violation.Amount"], sampleMergeData[,"paidPercentPerPenalty"], type = 'o', main = "No of times Penalty Paid before Decision per Amount", xlab = "Penalty Amount", ylab = "Percentage", col = "blue")

sampleMergeData <- mergeData[mergeData$Total.Violation.Amount < 1000,]
#Plot penalty amount vs ttl percentage and penalty paid percentage
plot(sampleMergeData[,"Total.Violation.Amount"], sampleMergeData[,"ttlPercent"], type = 'o', main = "", xlab = "Penalty Amount", ylab = "Percentage", col = "blue")
lines(sampleMergeData[,"Total.Violation.Amount"], sampleMergeData[,"paidPercentFromTotal"], col = "red")

#Barplot
head(mergeData)
rownames(sampleMergeData) <- sampleMergeData$Total.Violation.Amount
barplot(t(as.matrix(sampleMergeData[,c(2,4)])), col=c("darkblue","red"), legend=c("Total", "Paid"),ylim=c(0, 60), xlab = "Amount", main = "Per Amount Paid Penalty Before Decision", beside=TRUE)

#We can see that for lower penalty amount there is more percentage to pay penalty beofre decison. It is highest for penalty amount $25.


#How much revenue is lost on defaulted penalties
copyData2015 <- data2015
Convert violation date to month
#Extract month from violation date
copyData2015$Violation.Date <- format(as.Date(as.character(copyData2015$Violation.Date), "%m/%d/%Y"), "%m")
#Select defaulted violations
data15MonthDefaulted <- subset(copyData2015, (Hearing.Status == "DOCKETED" | Hearing.Status == "DEFAULTED") & Hearing.Result == "DEFAULTED", select = c("Violation.Date", "Total.Violation.Amount"))

#Select subset of data for all violations
data15Month <- subset(copyData2015, select = c("Violation.Date", "Total.Violation.Amount"))

#Aggregate default violations
dataMonthDeafaultedAgg <- do.call(data.frame, aggregate(cbind(sum = Total.Violation.Amount) ~ Violation.Date, data = data15MonthDefaulted, FUN = sum))
colnames(dataMonthDeafaultedAgg) <- c("Violation.Date", "DefaultedSum")
#Aggregate all violations
data15MonthAgg <- do.call(data.frame, aggregate(cbind(sum = Total.Violation.Amount) ~ Violation.Date, data = data15Month, FUN = sum))
colnames(data15MonthAgg) <- c("Violation.Date", "ttlSum")
#Join and calculate percentage
mergeData <- merge(x = data15MonthAgg, y = dataMonthDeafaultedAgg, by = "Violation.Date", all.x = TRUE)
mergeData$Violation.Date <- as.character(mergeData$Violation.Date)


#Plot bargraph
par(fig = c(0, 1, 0, 1), oma = c(0, 0, 0, 0), mar = c(0, 0, 0, 0), new = TRUE)

rownames(mergeData) <- mergeData$Violation.Date

barplot(t(as.matrix(mergeData[,c(2,3)])), xlab = "Month", col=c("darkblue","red"), main = "Monthwise Total Revenue and lost revenue", beside=TRUE)

legend("topleft", legend=c("Total", "Defaulted"), pch=20, col=c("darkblue","red"), horiz=TRUE, bty='n', cex=0.8)

colnames(mergeData)




#Find percentage of defaulted violations per agency, violationLoc, Penalty, Respondent Location
copyData2015 <- data2015
colnames(data2015)
#Select defaulted violations
data15Defaulted <- subset(copyData2015, (Hearing.Status == "DOCKETED" | Hearing.Status == "DEFAULTED") & Hearing.Result == "DEFAULTED", select = c("Charge..1..Code.Description", "Violation.Location..Zip.Code.", "Respondent.Address..Zip.Code.", "Total.Violation.Amount"))

#Select subset of data for all violations
data15All <- subset(copyData2015, select = c("Charge..1..Code.Description", "Violation.Location..Zip.Code.", "Respondent.Address..Zip.Code.", "Total.Violation.Amount"))

#Aggregate default violations
dataDeafaultedAgg <- do.call(data.frame, aggregate(cbind(DefaultedCount = Total.Violation.Amount) ~ (Charge..1..Code.Description + Violation.Location..Zip.Code. + Respondent.Address..Zip.Code. + Total.Violation.Amount), data = data15Defaulted, FUN = function(x)c({NROW(x)})))

#Aggregate all violations
data15AllAgg <- do.call(data.frame, aggregate(cbind(TotalCount = Total.Violation.Amount) ~ (Charge..1..Code.Description + Violation.Location..Zip.Code. + Respondent.Address..Zip.Code. + Total.Violation.Amount), data = data15All, FUN = function(x)c({NROW(x)})))
colnames(data15AllAgg)

#Group by all columns
mergeData <- merge(x = data15AllAgg, y = dataDeafaultedAgg, by = c("Charge..1..Code.Description", "Violation.Location..Zip.Code.", "Respondent.Address..Zip.Code.", "Total.Violation.Amount"), all.x = TRUE)
mergeData <- data.frame(apply(mergeData, 2, function(x){replace(x, is.na(x), 0)}))
head(mergeData)
str(mergeData)
mergeData$TotalCount <- as.numeric(as.character(mergeData$TotalCount))
mergeData$DefaultedCount <- as.numeric(as.character(mergeData$DefaultedCount))
mergeData$Violation.Location..Zip.Code. <- (as.character(mergeData$Violation.Location..Zip.Code.))
mergeData$Respondent.Address..Zip.Code. <- (as.character(mergeData$Respondent.Address..Zip.Code.))

#Agg by Violation zip code
mergeDataAgg <- aggregate(mergeData[,c("TotalCount", "DefaultedCount")], by = list(mergeData$Violation.Location..Zip.Code.), "sum")
colnames(mergeDataAgg) <-c("Violation.Location..Zip.Code.", "TotalCount", "DefaultedCount")
mergeDataAgg <- mergeDataAgg[(nchar(mergeDataAgg$Violation.Location..Zip.Code.) == 5 & mergeDataAgg$TotalCount >= 100),]
mergeDataAgg$Percentage <- (mergeDataAgg$DefaultedCount/ mergeDataAgg$TotalCount) * 100
top10 <- head(mergeDataAgg[order(mergeDataAgg$Percentage, decreasing = T), c(1,4)], 10)
top10

#Agg by respondent Zip code
head(mergeData)
mergeDataAgg <- aggregate(mergeData[,c("TotalCount", "DefaultedCount")], by = list(mergeData$Respondent.Address..Zip.Code.), "sum")
colnames(mergeDataAgg) <-c("Respondent.Address..Zip.Code.", "TotalCount", "DefaultedCount")
mergeDataAgg <- mergeDataAgg[(nchar(mergeDataAgg$Respondent.Address..Zip.Code.) == 5 & mergeDataAgg$TotalCount >= 100),]
mergeDataAgg$Percentage <- (mergeDataAgg$DefaultedCount/ mergeDataAgg$TotalCount) * 100
top10 <- head(mergeDataAgg[order(mergeDataAgg$Percentage, decreasing = T), c(1,4)], 10)
top10


#Agg by Charge
head(mergeData)
mergeDataAgg <- aggregate(mergeData[,c("TotalCount", "DefaultedCount")], by = list(mergeData$Charge..1..Code.Description), "sum")
colnames(mergeDataAgg) <-c("Charge..1..Code.Description", "TotalCount", "DefaultedCount")
mergeDataAgg <- mergeDataAgg[(mergeDataAgg$TotalCount >= 100),]
mergeDataAgg$Percentage <- (mergeDataAgg$DefaultedCount/ mergeDataAgg$TotalCount) * 100
top10 <- head(mergeDataAgg[order(mergeDataAgg$Percentage, decreasing = T), c(1,4)], 10)
top10


#Agg by Amount
head(mergeData)
mergeDataAgg <- aggregate(mergeData[,c("TotalCount", "DefaultedCount")], by = list(mergeData$Total.Violation.Amount), "sum")
colnames(mergeDataAgg) <-c("Total.Violation.Amount", "TotalCount", "DefaultedCount")
mergeDataAgg <- mergeDataAgg[(mergeDataAgg$TotalCount >= 100),]
mergeDataAgg$Percentage <- (mergeDataAgg$DefaultedCount/ mergeDataAgg$TotalCount) * 100
top10 <- head(mergeDataAgg[order(mergeDataAgg$Percentage, decreasing = T), c(1,2, 4)], 10)
top10












mergeData$Percentage <- (mergeData[,"DefaultedCount"]/mergeData[,"TotalCount"])*100
mergeData <- data.frame(apply(mergeData, 2, function(x){replace(x, is.na(x), 0)}))
mergeData$Percentage <- as.numeric(as.character(mergeData$Percentage))





#Join and calculate percentage
mergeData <- merge(x = data15AllAgg, y = dataDeafaultedAgg, by = c("Charge..1..Code.Description", "Violation.Location..Zip.Code.", "Respondent.Address..Zip.Code.", "Total.Violation.Amount"), all.x = TRUE)
mergeData$Percentage <- (mergeData[,"DefaultedCount"]/mergeData[,"TotalCount"])*100
mergeData <- data.frame(apply(mergeData, 2, function(x){replace(x, is.na(x), 0)}))
mergeData$Percentage <- as.numeric(as.character(mergeData$Percentage))

mergeData <- subset(mergeData, as.numeric(TotalCount) > 100,select = c( "Charge..1..Code.Description", "Violation.Location..Zip.Code.", "Respondent.Address..Zip.Code.", "Total.Violation.Amount", "TotalCount", "DefaultedCount", "Percentage"))

head(mergeData)


#Top 100 combination of Issuing Agency, Violation Address, Respondent Address, Total Violation amount where most of violations are defaulted
top100 <- head(mergeData[order(mergeData$Percentage,decreasing=T),], 100)
bottom100 <- head(mergeData[order(mergeData$Percentage),], 100)

top100


# Clean Neighborhoods
install.packages("rgdal")
install.packages("stringr")
install.packages("rgeos")
install.packages("dplyr")
install.packages("Hmisc")

library(rgdal)

nyc <- readOGR(dsn = "ZIP_CODE_040114", layer = "ZIP_CODE_040114")

#Find out all violations related data from 

head(data2015)

words <- c("clean", "receptacle", "dirty", "rubbish", "dirt", "waste", "garbage", "litter", "disposal", "dumping", "mosquito", "smoke")
dataClean <- data2015[ifelse (rowSums(sapply(words, grepl, data2015$Charge..1..Code.Description, ignore.case = TRUE)) > 0, TRUE, FALSE),]
library(stringr)
dataClean$Charge..1..Code.Description <- str_trim(dataClean$Charge..1..Code.Description)
#Just to check what all records selected
#unique(tolower(dataClean$Charge..1..Code.Description))

#Group by violation zip code and take count
dataCleanAgg <- do.call(data.frame, aggregate(cbind(count = Violation.Location..Zip.Code.) ~ Violation.Location..Zip.Code., data = dataClean, FUN = function(x) c({NROW(x)})))
colnames(dataCleanAgg) <- c("ZIPCODE", "count")
library(ggplot2)
library(Hmisc)
#table(cut2(dataCleanAgg$count, c(30, 300, 1000, 4000)))

#dataCleanAgg$countGrp <- as.factor(as.numeric(cut2(dataCleanAgg$count, c(30, #300, 1000, 4000))))
dataCleanAgg <- subset(dataCleanAgg, nchar(as.character(dataCleanAgg$ZIPCODE)) == 5)
dataCleanAgg$countGrp <- cut2(dataCleanAgg$count, c(0, 1, 30, 300, 1000, 4000))
levels(dataCleanAgg$countGrp)
as.numeric(dataCleanAgg$countGrp)

#Left join with shape file data Ignoring Blank, 0 zipcodes from violation data
nyc@data <- merge(x = nyc@data, y = dataCleanAgg, by = "ZIPCODE", all.x = TRUE)
#Replacing NAs with group 1 to include 0 violations.
nyc@data <- data.frame(apply(nyc@data, 2, function(x){replace(x, is.na(x), "   0")}))

colnames(nyc@data)

#Plot map

library(rgeos)
nyc_f <- fortify(nyc)
head(nyc_f)
nyc$id <- row.names(nyc)
head(nyc@data, n = 5)
library(dplyr)
nyc_f <- left_join(nyc_f, nyc@data)

head(nyc_f)

head(nyc@data, 60)
head(nyc_f)
nyc_f@data

map <- ggplot() +
geom_polygon(data = nyc_f, aes(x = long, y = lat, group = group, fill = countGrp), color = "black", size = 0.25) +
coord_equal() +
labs(fill = "Number of Cleanliness\nRelated Violations 2015") +
ggtitle("Clean Neighborhoods")

map
save.pdf(map)

